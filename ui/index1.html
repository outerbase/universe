<html>
<head>
    <title>Test</title>

    <script src="./universe-editor/editor-lite.js" defer></script>
    <script src="./universe-editor/prism-lite/prism.js" defer></script>

    <link href="./universe-editor/prism-lite/prism.css" rel="stylesheet" />

    <style>
        body {
            margin: 0;
            background-color: black;
            width: 100%;
            height: 100%;
            overflow: scroll;
        }

        textarea {
            resize: none;
            outline: none;
        }

        pre, textarea, code {
            padding: 0 !important;
            margin: 0 !important;
            min-height: 100%;
            min-width: 100%;
            font-family: monospace;
            font-size: 14px  !important;
            line-height: 17px !important;
            background-color: transparent !important;
        }

        .editor {
            color: transparent;
            caret-color: white;
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            left: 0;
            top: 0;
        }

        code {
            pointer-events: none;
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
            color: white;
        }

        .width-measure {
            font-family: monospace;
            font-size: 14px;
            visibility: hidden;
            white-space: pre;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* .token.keyword {
            color: blue !important;
        } */
    </style>
</head>

<body>
    <textarea class="editor"></textarea>
    <pre><code class="language-js"></code></pre>
    <span class="width-measure" style="white-space:pre;visibility:hidden;position:absolute;"></span>
</body>

<script>
    var editor = document.querySelector(".editor"),
    visualizer = document.querySelector("code"),
    widthMeasure = document.querySelector(".width-measure");

    function adjustTextareaHeight(textarea) {
        // Reset the height to ensure we're not measuring the old content
        textarea.style.height = 'auto';
        // Adjust the height to match the scroll height of the content
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    function adjustTextareaWidth(textarea) {
        // Copy textarea content into the widthMeasure span
        widthMeasure.textContent = textarea.value || textarea.placeholder;
        // Adjust the textarea width based on the widthMeasure span's width
        textarea.style.width = Math.max(widthMeasure.offsetWidth + 1, textarea.scrollWidth) + 'px';
    }

    function indentLine(textarea, direction) {
        var start = textarea.selectionStart;
        var end = textarea.selectionEnd;
        var selectedText = textarea.value.substring(start, end);
        var beforeText = textarea.value.substring(0, start);
        var afterText = textarea.value.substring(end);

        // Find the start of the current line
        var lineStart = beforeText.lastIndexOf("\n") + 1;

        if (direction === 'right') {
            // Add a tab (or spaces) at the start of the line
            textarea.value = beforeText.substring(0, lineStart) + "    " + beforeText.substring(lineStart) + selectedText + afterText;
            // Adjust the cursor position
            textarea.selectionStart = start + 4; // Assuming 4 spaces or 1 tab
            textarea.selectionEnd = end + 4;
        } else if (direction === 'left') {
            // Remove a tab (or spaces) from the start of the line if present
            var lineIndent = beforeText.substring(lineStart);
            if (lineIndent.startsWith("    ")) { // Assuming 4 spaces or 1 tab
                textarea.value = beforeText.substring(0, lineStart) + beforeText.substring(lineStart + 4) + selectedText + afterText;
                // Adjust the cursor position
                textarea.selectionStart = start - 4 > lineStart ? start - 4 : lineStart;
                textarea.selectionEnd = end - 4 > lineStart ? end - 4 : lineStart;
            }
        }
    }

    editor.addEventListener("input", (e) => {
        var escapedCode = e.target.value;
        visualizer.innerHTML = escapedCode;
        Prism.highlightElement(visualizer);
        adjustTextareaHeight(editor);
        adjustTextareaWidth(editor);
    });

    editor.addEventListener("keydown", function(e) {
        if (e.key === "Tab") {
            e.preventDefault(); // Stop the default tab behavior
            var start = this.selectionStart;
            var end = this.selectionEnd;

            // Set textarea value to: text before caret + tab + text after caret
            this.value = this.value.substring(0, start) +
                         "    " + // This is where the tab character or spaces go
                         this.value.substring(end);

            // Put caret at right position again (after the inserted tab)
            this.selectionStart =
            this.selectionEnd = start + 4; // Move the caret after the tab (4 spaces here)
        }  
        else if (e.key === "Enter") {
            e.preventDefault(); // Prevent the default enter behavior

            var start = this.selectionStart;
            var end = this.selectionEnd;
            var beforeText = this.value.substring(0, start);
            var afterText = this.value.substring(end);

            // Find the start of the current line
            var lineStart = beforeText.lastIndexOf("\n") + 1;
            // Calculate the indentation of the current line
            var indentation = beforeText.substring(lineStart).match(/^(\s*)/)[0];

            // Insert newline and the same indentation
            this.value = beforeText + "\n" + indentation + afterText;

            // Update cursor position
            var newPos = start + 1 + indentation.length; // Move cursor after the new indentation
            this.selectionStart = this.selectionEnd = newPos;
        } 
        else  if (e.metaKey && e.key === ']') {
            // Check for CMD + ] for right indent
            e.preventDefault(); // Prevent the default action
            indentLine(this, 'right');
        }
        else if (e.metaKey && e.key === '[') {
            // Check for CMD + [ for left indent
            e.preventDefault(); // Prevent the default action
            indentLine(this, 'left');
        }

        // Force reflow/repaint
        var forcedReflow = this.offsetHeight;

        Prism.highlightElement(visualizer);
        adjustTextareaWidth(editor);

        this.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
    });

    // Initial adjustment in case of any pre-filled content
    adjustTextareaHeight(editor);
    adjustTextareaWidth(editor);
</script>


</html>